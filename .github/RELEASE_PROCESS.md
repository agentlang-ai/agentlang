# Release Process

This repository uses an automated release preparation workflow that triggers when you push a version tag.

## How It Works

1. **Push a Version Tag**: When you push a tag like `0.8.3`, the workflow automatically triggers
2. **PR Creation**: The workflow creates a Pull Request that includes:
   - Updated `package.json` with the new version
   - Updated `CHANGELOG.md` with all commits since the last tag
   - Updated `package-lock.json` (via `npm install`)
   - Updated `pnpm-lock.yaml` (via `pnpm install`)
   - Links to all commits with author mentions
3. **Review & Merge**: Review the PR and merge it to apply the changes
4. **Publish**: The existing publish workflow handles npm publishing when the tag exists

## Step-by-Step Release Workflow

### 1. Decide on the Version Number

Follow [Semantic Versioning](https://semver.org/):
- **Major** (1.0.0 → 2.0.0): Breaking changes
- **Minor** (0.8.0 → 0.9.0): New features, backwards compatible
- **Patch** (0.8.2 → 0.8.3): Bug fixes, backwards compatible

### 2. Create and Push the Tag

```bash
# Create a tag locally (recommended: no 'v' prefix)
git tag 0.8.3

# Push the tag to trigger the workflow
git push origin 0.8.3

# Note: Tags with 'v' prefix also work as a fallback
git tag v0.8.3  # This also works, 'v' will be stripped
```

### 3. Workflow Runs Automatically

The workflow will:
- Extract the version from the tag (strips 'v' prefix if present)
- Find all commits since the previous tag
- Generate a CHANGELOG entry with:
  - Commit messages
  - Links to each commit
  - Author mentions
- Update `package.json` version
- Run `npm install` to update `package-lock.json`
- Run `pnpm install` to update `pnpm-lock.yaml`
- Create a Pull Request with all these changes

### 4. Review the Pull Request

The automated PR will be titled **"Release X.Y.Z"** and will include:
- All file changes (package.json, CHANGELOG.md, lock files)
- A summary of commits included in this release
- Links to individual commits
- Author attributions

Review the PR to ensure:
- Version number is correct
- All commits since the last tag are included
- CHANGELOG entries are accurate
- Lock files are properly updated

### 5. Merge the Pull Request

Once approved, merge the PR. This will:
- Update the repository with the new version
- Update the CHANGELOG
- Ensure lock files are in sync

### 6. Publishing to npm

The existing `publish.yml` workflow will handle publishing to npm automatically when:
- A tag is pushed (which you already did in step 2)
- A GitHub release is published

## CHANGELOG Format

The CHANGELOG is automatically generated in the following format:

```markdown
## [0.8.3](https://github.com/org/repo/compare/v0.8.2...v0.8.3) (2025-12-30)

### Changes

* support arbitrary functions in @default ([abc123](https://github.com/org/repo/commit/abc123)) - @username
* Aggregate queries ([def456](https://github.com/org/repo/commit/def456)) - @username
* support new config syntax ([ghi789](https://github.com/org/repo/commit/ghi789)) - @username

---
```

Each entry includes:
- The commit message
- A direct link to the commit
- The commit author's username

## Example Complete Release

```bash
# 1. Make sure you're on main with latest changes
git checkout main
git pull origin main

# 2. Create and push the version tag
git tag 0.9.0
git push origin 0.9.0

# 3. Wait for the GitHub Actions workflow to complete (~1-2 minutes)
#    Check: https://github.com/agentlang-ai/agentlang/actions

# 4. Review the auto-generated PR
#    Go to: https://github.com/agentlang-ai/agentlang/pulls

# 5. Merge the PR after review

# 6. The publish workflow automatically publishes to npm
#    Check: https://www.npmjs.com/package/agentlang
```

## Lock File Updates

Both lock files are updated in the workflow:

- **`package-lock.json`**: Generated by `npm install`
- **`pnpm-lock.yaml`**: Generated by `pnpm install --no-frozen-lockfile`

This ensures both package managers have up-to-date lock files after the version bump.

## Troubleshooting

### Workflow doesn't trigger

- Ensure the tag follows the format: `X.Y.Z` or `vX.Y.Z` (e.g., `0.8.3`, `1.0.0`, `v0.8.3`)
- Recommended: Use tags without 'v' prefix (`0.8.3`), but `v0.8.3` also works
- Check that you pushed the tag: `git push origin <tag-name>`
- Verify GitHub Actions is enabled for the repository

### PR not created

- Check the Actions tab for workflow errors
- Ensure GitHub Actions has proper permissions (contents: write, pull-requests: write)
- Verify the `GITHUB_TOKEN` has access to create PRs

### Wrong commits in CHANGELOG

- The CHANGELOG includes all commits between the previous tag and the current tag
- Ensure you're tagging from the correct commit
- Use `git log <prev-tag>..<current-tag>` to preview commits

### Lock files not updated correctly

- The workflow runs both `npm install` and `pnpm install`
- If there are dependency issues, the workflow will fail
- Check the Actions logs for specific errors

### Duplicate tags

- If you need to retag, delete the tag first:
  ```bash
  git tag -d v0.8.3
  git push origin :refs/tags/v0.8.3
  ```
- Then create and push the new tag

## Manual CHANGELOG Updates

If you need to manually edit the CHANGELOG:
1. Wait for the automated PR to be created
2. Check out the PR branch locally
3. Edit `CHANGELOG.md` as needed
4. Commit and push to the PR branch
5. The PR will update automatically

## Best Practices

1. **Tag from main**: Always create tags from the `main` branch
2. **Test before tagging**: Ensure all tests pass before creating a release tag
3. **Use semantic versioning**: Follow semver guidelines for version numbers
4. **Review the PR**: Always review the automated PR before merging
5. **Clear commit messages**: Write clear commit messages since they appear in the CHANGELOG
6. **One tag per release**: Don't create multiple tags for the same version

## Migration from Old Process

If you were previously using manual releases:
1. Ensure your last release has a git tag
2. If not, create a tag for the current version: `git tag 0.8.2 <commit-sha>`
3. Push the tag: `git push origin 0.8.2`
4. Future releases will automatically compare against this tag

## Configuration

The workflow configuration is in `.github/workflows/release-please.yml`:

- **Trigger**: Accepts both `X.Y.Z` and `vX.Y.Z` formats (v prefix is stripped automatically)
- **Node version**: 22
- **Package managers**: npm and pnpm
- **PR labels**: `release`, `automated`

For advanced customization, edit the workflow file.
